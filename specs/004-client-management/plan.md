# Implementation Plan: Client Management

**Branch**: `004-client-management` | **Date**: 2026-02-06 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification for basic client management with Individual/Business types, PII encryption, and RBAC

## Summary

Implement full-stack client management supporting Individual (SSN) and Business (EIN) taxpayer types. Core capabilities include PII encryption with masking, role-based access control (Admin, TaxProfessional, ReadOnly), soft-delete/archive functionality, and a searchable/sortable client list. The existing domain model, encryption infrastructure, and RLS multi-tenancy provide a strong foundation requiring targeted extensions rather than new systems.

## Technical Context

**Language/Version**: C# 13 / .NET 9, TypeScript 5.4
**Primary Dependencies**: ASP.NET Core, Entity Framework Core 9, Next.js 14, Material-UI
**Storage**: PostgreSQL 16 with Row-Level Security
**Testing**: xUnit, FluentAssertions, Playwright, Jest
**Target Platform**: Linux containers (Azure App Service), Web browser
**Project Type**: Full-stack web application (API + SPA)
**Performance Goals**: Client list loads < 2 seconds for 1,000 clients
**Constraints**: Max 100 items per page, all PII encrypted at rest
**Scale/Scope**: Support organizations with up to 10,000 clients

## Constitution Check

*GATE: All principles validated - ready for implementation*

| Principle | Status | Validation |
|-----------|--------|------------|
| I. Security-First | ✅ PASS | AES-256 encryption exists, RBAC configured, audit logging ready |
| II. Test-Driven Development | ✅ PASS | Contract tests will be written first per workflow |
| III. Clean Architecture | ✅ PASS | Domain/Application/Infrastructure separation maintained |
| IV. API-First Design | ✅ PASS | OpenAPI contract exists and will be updated before implementation |
| V. Scalability | ✅ PASS | Pagination enforced, stateless services, RLS for isolation |

## Project Structure

### Documentation (this feature)

```text
specs/004-client-management/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file
├── research.md          # Phase 0 research findings
├── data-model.md        # Entity relationships and fields
├── quickstart.md        # Local development setup
├── contracts/           # Updated OpenAPI specifications
│   └── clients-api.yaml # Extended client management contract
└── tasks.md             # Task breakdown (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── TranscriptAnalyzer.Domain/
│   │   ├── Entities/
│   │   │   └── Client.cs           # Extend with Archive/Restore
│   │   └── Enums/
│   │       └── BusinessEntityType.cs # Add NonProfit, Trust, Estate
│   ├── TranscriptAnalyzer.Application/
│   │   └── Clients/
│   │       ├── Commands/
│   │       │   ├── CreateClient/
│   │       │   ├── UpdateClient/
│   │       │   ├── ArchiveClient/
│   │       │   └── RestoreClient/
│   │       ├── Queries/
│   │       │   ├── GetClient/
│   │       │   └── ListClients/
│   │       └── DTOs/
│   └── TranscriptAnalyzer.Api/
│       └── Endpoints/
│           └── ClientsEndpoints.cs
└── tests/
    ├── TranscriptAnalyzer.Api.Tests/
    │   └── Clients/
    │       └── ClientsContractTests.cs
    └── TranscriptAnalyzer.Application.Tests/
        └── Clients/

frontend/
├── src/
│   ├── components/
│   │   └── clients/
│   │       ├── ClientList.tsx
│   │       ├── ClientForm.tsx
│   │       ├── ClientDetail.tsx
│   │       └── TaxIdentifierInput.tsx
│   ├── app/(dashboard)/
│   │   └── clients/
│   │       ├── page.tsx           # List
│   │       ├── new/page.tsx       # Create
│   │       └── [id]/
│   │           ├── page.tsx       # Detail
│   │           └── edit/page.tsx  # Edit
│   └── lib/
│       └── api/
│           └── clientsApi.ts      # RTK Query slice
└── tests/
    └── clients/
```

**Structure Decision**: Web application pattern with separate backend (ASP.NET Core API) and frontend (Next.js SPA). This matches the existing repository structure and supports independent deployment.

## Implementation Phases

### Phase 1: Contract & Domain Updates

**Objective**: Establish API contract and extend domain model

**Tasks**:
1. Update `BusinessEntityType` enum with NonProfit, Trust, Estate
2. Add `Archive()` and `Restore()` methods to Client entity
3. Create EF migration for enum extension
4. Update clients-api.yaml with new entity types and restore endpoint

**Exit Criteria**:
- Migration runs successfully
- API contract validates with OpenAPI linter

### Phase 2: Backend CQRS Implementation

**Objective**: Implement command/query handlers with validation

**Tasks**:
1. Create DTOs: ClientDto, ClientListItemDto, CreateClientRequest, UpdateClientRequest
2. Implement CreateClientCommand with FluentValidation
3. Implement UpdateClientCommand with optimistic concurrency
4. Implement GetClientQuery with masking
5. Implement ListClientsQuery with pagination, search, sort
6. Implement ArchiveClientCommand (Admin only)
7. Implement RestoreClientCommand (Admin only)
8. Write contract tests for all handlers

**Exit Criteria**:
- All handlers have passing contract tests
- Validation rejects invalid SSN/EIN formats
- PII never exposed in responses (only last 4)

### Phase 3: API Endpoints

**Objective**: Wire up Minimal API endpoints with authorization

**Tasks**:
1. Implement GET /api/v1/clients endpoint
2. Implement POST /api/v1/clients endpoint
3. Implement GET /api/v1/clients/{id} endpoint
4. Implement PATCH /api/v1/clients/{id} endpoint
5. Implement DELETE /api/v1/clients/{id} endpoint (Admin)
6. Implement POST /api/v1/clients/{id}/restore endpoint (Admin)
7. Add role-based authorization policies
8. Write integration tests

**Exit Criteria**:
- All endpoints return correct status codes
- RBAC enforced server-side
- RLS prevents cross-tenant access

### Phase 4: Frontend Implementation

**Objective**: Build client management UI following CargoMax patterns

**Tasks**:
1. Create RTK Query API slice for clients
2. Implement ClientList component with MUI DataGrid
3. Implement TaxIdentifierInput with masking
4. Implement ClientForm with validation
5. Implement ClientDetail view
6. Create list page at /clients
7. Create create page at /clients/new
8. Create detail page at /clients/[id]
9. Create edit page at /clients/[id]/edit
10. Implement role-based UI hiding

**Exit Criteria**:
- All CRUD operations work end-to-end
- SSN/EIN masked in all views
- Edit/Delete hidden for unauthorized roles

### Phase 5: Testing & Polish

**Objective**: Ensure quality and handle edge cases

**Tasks**:
1. Add Playwright E2E tests for critical paths
2. Test duplicate SSN/EIN warning flow
3. Test archive/restore flow (Admin)
4. Test concurrent edit conflict handling
5. Verify audit log entries
6. Performance test with 1,000 clients

**Exit Criteria**:
- All acceptance scenarios pass
- 80% backend coverage
- No security vulnerabilities

## Complexity Tracking

> No violations identified - implementation follows established patterns

| Aspect | Status | Notes |
|--------|--------|-------|
| New dependencies | None | Uses existing stack |
| Database changes | Minimal | Enum extension only |
| External integrations | None | Self-contained feature |
| Security model | Existing | Leverages existing RBAC + RLS |

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| SSN/EIN validation edge cases | Strict regex + comprehensive test cases |
| Role authorization bypass | Server-side enforcement, integration tests |
| Migration issues with enum | Test migration in development first |
| Frontend performance with large lists | Virtual scrolling, pagination enforcement |

## Dependencies

**Internal**:
- 003-postgres-migration (RLS) - ✅ Complete

**External**:
- None - self-contained feature

## Definition of Done

- [ ] All 6 user stories pass acceptance criteria
- [ ] Backend test coverage ≥ 80%
- [ ] No failing tests in CI
- [ ] API contract validated
- [ ] Security review passed (PII handling)
- [ ] Audit logging verified
- [ ] Documentation complete
