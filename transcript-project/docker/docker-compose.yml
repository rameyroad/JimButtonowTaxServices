# Transcript Analyzer - Docker Compose Configuration
# Local development environment with hot reload support
#
# Usage:
#   docker compose up                    # Start infrastructure only
#   docker compose --profile api up      # Start API + infrastructure
#   docker compose --profile full up     # Start all services
#   docker compose --profile tools up    # Start with dev tools
#
# See .env.template for configuration options

services:
  # =============================================================================
  # Infrastructure - Database
  # =============================================================================

  postgres:
    image: postgres:16-alpine
    container_name: transcript-postgres
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-YourStrong@Passw0rd}"
      POSTGRES_DB: "${POSTGRES_DB:-transcript_analyzer}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-transcript_analyzer}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - transcript-network
    restart: unless-stopped

  # =============================================================================
  # Infrastructure - Cache
  # =============================================================================

  redis:
    image: redis:7-alpine
    container_name: transcript-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - transcript-network
    restart: unless-stopped

  # =============================================================================
  # Infrastructure - Azure Storage Emulator
  # =============================================================================

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: transcript-azurite
    ports:
      - "${AZURITE_BLOB_PORT:-10000}:10000"
      - "${AZURITE_QUEUE_PORT:-10001}:10001"
      - "${AZURITE_TABLE_PORT:-10002}:10002"
    volumes:
      - azurite-data:/data
    command: azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --location /data --debug /data/debug.log
    networks:
      - transcript-network
    restart: unless-stopped

  # =============================================================================
  # Infrastructure - Observability (Logging)
  # =============================================================================

  seq:
    image: datalust/seq:latest
    container_name: transcript-seq
    ports:
      - "${SEQ_INGESTION_PORT:-5341}:5341"
      - "${SEQ_UI_PORT:-8081}:80"
    environment:
      ACCEPT_EULA: "Y"
      SEQ_FIRSTRUN_ADMINPASSWORD: "${SEQ_ADMIN_PASSWORD:-admin}"
    volumes:
      - seq-data:/data
    networks:
      - transcript-network
    restart: unless-stopped

  # =============================================================================
  # Backend - .NET API
  # =============================================================================

  api:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    profiles: ["api", "backend", "full", "tools"]
    container_name: transcript-api
    working_dir: /app
    command: dotnet watch run --project src/TranscriptAnalyzer.Api/TranscriptAnalyzer.Api.csproj --urls http://+:8080
    ports:
      - "${API_PORT:-5100}:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - DOTNET_USE_POLLING_FILE_WATCHER=1
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=1
      # Database
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=${POSTGRES_DB:-transcript_analyzer};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-YourStrong@Passw0rd}
      # Redis
      - ConnectionStrings__Redis=redis:6379
      # Seq Logging
      - Seq__ServerUrl=http://seq:5341
      # Azure Storage (Azurite)
      - AzureStorage__ConnectionString=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;
      # Security
      - Encryption__Key=${ENCRYPTION_KEY:-g/HSs5iu03tesTi8FeSf/UCM446N6osX/2jUq9gbsLE=}
      # Auth
      - Auth__UseDevAuth=${USE_DEV_AUTH:-true}
      - Auth__Authority=https://${AUTH0_DOMAIN:-your-tenant.auth0.com}/
      - Auth__Audience=${AUTH0_AUDIENCE:-https://api.transcript-analyzer.com}
      # Email
      - Email__Provider=${EMAIL_PROVIDER:-SendGrid}
      - Email__TestMode=${EMAIL_TEST_MODE:-true}
      - SendGrid__ApiKey=${SENDGRID_API_KEY:-}
      - SendGrid__FromEmail=${SENDGRID_FROM_EMAIL:-noreply@your-domain.com}
      # Platform Admin
      - PlatformAdmin__Email=${PLATFORM_ADMIN_EMAIL:-admin@local.dev}
      - PlatformAdmin__FirstName=${PLATFORM_ADMIN_FIRST_NAME:-Admin}
      - PlatformAdmin__LastName=${PLATFORM_ADMIN_LAST_NAME:-User}
    volumes:
      - ../backend:/app
      - api-nuget-cache:/root/.nuget/packages
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      seq:
        condition: service_started
      azurite:
        condition: service_started
    healthcheck:
      test: curl -sf http://localhost:8080/health || exit 1
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - transcript-network
    restart: unless-stopped

  # =============================================================================
  # Frontend - Next.js Web Application
  # =============================================================================

  web:
    image: node:20-alpine
    profiles: ["web", "frontend", "full", "tools"]
    container_name: transcript-web
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://localhost:${API_PORT:-5100}
      - WATCHPACK_POLLING=true
      # Auth settings
      - NEXT_PUBLIC_USE_DEV_AUTH=${USE_DEV_AUTH:-true}
      - NEXT_PUBLIC_AUTH0_DOMAIN=${AUTH0_DOMAIN:-your-tenant.auth0.com}
      - NEXT_PUBLIC_AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID:-your-client-id}
      - NEXT_PUBLIC_AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-https://api.transcript-analyzer.com}
    volumes:
      - ../frontend:/app
      - web-node-modules:/app/node_modules
    depends_on:
      api:
        condition: service_started
    healthcheck:
      test: wget -qO- http://localhost:3000 || exit 1
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - transcript-network
    restart: unless-stopped

  # =============================================================================
  # Development Tools (optional)
  # =============================================================================

  pgadmin:
    image: dpage/pgadmin4:latest
    profiles: ["tools"]
    container_name: transcript-pgadmin
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: "${PGADMIN_EMAIL:-admin@local.dev}"
      PGADMIN_DEFAULT_PASSWORD: "${PGADMIN_PASSWORD:-admin}"
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - transcript-network
    restart: unless-stopped

  redis-commander:
    image: rediscommander/redis-commander:latest
    profiles: ["tools"]
    container_name: transcript-redis-commander
    ports:
      - "${REDIS_COMMANDER_PORT:-8082}:8081"
    environment:
      REDIS_HOSTS: local:redis:6379
    depends_on:
      - redis
    networks:
      - transcript-network
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================

networks:
  transcript-network:
    driver: bridge
    name: transcript-network

# =============================================================================
# Volumes
# =============================================================================

volumes:
  postgres-data:
    name: transcript-postgres-data
  redis-data:
    name: transcript-redis-data
  azurite-data:
    name: transcript-azurite-data
  seq-data:
    name: transcript-seq-data
  api-nuget-cache:
    name: transcript-api-nuget-cache
  web-node-modules:
    name: transcript-web-node-modules
  pgadmin-data:
    name: transcript-pgadmin-data
